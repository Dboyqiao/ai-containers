BASE_IMAGE_NAME ?= ubuntu
BASE_IMAGE_TAG ?= 22.04
BAZEL_VERSION ?= 5.4.0
DOCKER_BUILDKIT ?= 1
INC_VERSION ?= 1.13
MINICONDA_VERSION ?= "py39_4.12.0-Linux-x86_64"
PACKAGE_OPTION ?= pip
PYTHON_VERSION ?= python3
TF_PACKAGE ?= intel-tensorflow
TF_PACKAGE_VERSION ?= 2.11.0
TF_SERVING_BAZEL_OPTIONS ?= '--local_ram_resources=HOST_RAM*0.8 --local_cpu_resources=HOST_CPUS-4'
TF_SERVING_BUILD_OPTIONS ?= '--config=mkl --config=release --define=build_with_openmp=false --copt=-march=native'
FINAL_IMAGE_NAME ?= ${TF_PACKAGE}

tf-base:
	mkdir -p base/licensing && \
	wget -O - https://github.com/Intel-tensorflow/tensorflow/archive/v${TF_PACKAGE_VERSION}.tar.gz | \
	tar -xz -C base/licensing --strip=2 "tensorflow-${TF_PACKAGE_VERSION}/third_party_programs_license/"
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 MINICONDA_VERSION=${MINICONDA_VERSION} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 PYTHON_VERSION=${PYTHON_VERSION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 TF_PACKAGE=${TF_PACKAGE} \
	 docker compose up --build tf-base

jupyter: tf-base
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build jupyter

openmpi: tf-base
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build openmpi

mpich: tf-base
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build mpich

openmpi-horovod: openmpi
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build openmpi-horovod

mpich-horovod: mpich
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build mpich-horovod

mpich-horovod-inc: mpich-horovod
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 INC_VERSION=${INC_VERSION} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build mpich-horovod-inc

openmpi-horovod-inc: openmpi-horovod
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 INC_VERSION=${INC_VERSION} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build openmpi-horovod-inc

mpich-horovod-inc-onnx: mpich-horovod-inc
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build mpich-horovod-inc-onnx

openmpi-horovod-inc-onnx: openmpi-horovod-inc
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 docker compose up --build openmpi-horovod-inc-onnx

tf-serving:
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 BAZEL_VERSION=${BAZEL_VERSION} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	 TF_SERVING_BAZEL_OPTIONS=${TF_SERVING_BAZEL_OPTIONS} \
	 TF_SERVING_BUILD_OPTIONS=${TF_SERVING_BUILD_OPTIONS} \
	docker compose build tf-serving

serving-mkl: tf-serving
	@DOCKER_BUILDKIT=${DOCKER_BUILDKIT} \
	 BASE_IMAGE_NAME=${BASE_IMAGE_NAME} \
	 BASE_IMAGE_TAG=${BASE_IMAGE_TAG} \
	 FINAL_IMAGE_NAME=${FINAL_IMAGE_NAME} \
	 PACKAGE_OPTION=${PACKAGE_OPTION} \
	 TF_PACKAGE_VERSION=${TF_PACKAGE_VERSION} \
	docker compose build serving-mkl

all: jupyter mpich-horovod-inc-onnx openmpi-horovod-inc-onnx serving-mkl

clean:
	rm -rf base/licensing
	docker compose down